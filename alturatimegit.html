<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AlturaTime</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://unpkg.com/ical.js@1.4.0/build/ical.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8fafb; color: #203040; }
    h1 { color: #2a9078; }
    .btn { padding: 10px 14px; background: #2a9078; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin: 10px 0; }
    .call-status.safe { background: #5fb878; color: white; padding: 6px 10px; border-radius: 4px; }
    .call-status.avoid { background: #ef476f; color: white; padding: 6px 10px; border-radius: 4px; }
    .call-status.maybe { background: #ffd166; color: #745800; padding: 6px 10px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>AlturaTime</h1>
  <p>Create a link for loved ones to see your schedule.</p>

  <div class="card">
    <input id="name" placeholder="Your name"><br><br>
    <input type="file" id="file" accept=".ics"><br><br>
    <button class="btn" onclick="makeLink()">Generate Link</button>
  </div>

  <p id="link"></p>

  <div id="schedule"></div>

  <script>
    function makeLink() {
      const name = document.getElementById("name").value.trim();
      const file = document.getElementById("file").files[0];
      if (!name || !file) {
        alert("Enter your name and choose a file!");
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        const icsData = encodeURIComponent(reader.result);
        const url = `${location.origin}${location.pathname}?name=${encodeURIComponent(name)}&ics=${icsData}`;
        document.getElementById("link").innerHTML = 
          `Share this link: <a href="${url}" target="_blank">${url}</a>`;
      };
      reader.readAsText(file);
    }

    function parseICS(icsText) {
      const jcal = ICAL.parse(icsText);
      const comp = new ICAL.Component(jcal);
      const events = comp.getAllSubcomponents("vevent");
      return events.map(e => new ICAL.Event(e));
    }

    function renderSchedule(name, icsText) {
      const container = document.getElementById("schedule");
      container.innerHTML = `<h2>${name}'s Schedule</h2>`;
      const events = parseICS(icsText);

      const now = new Date();
      let html = "";
      events.forEach(ev => {
        const start = ev.startDate.toJSDate();
        const end = ev.endDate.toJSDate();
        const status = (now >= start && now <= end) ? "CLASS IN SESSION" :
                       (now < start) ? "UPCOMING" : "PAST";
        html += `<div class="card"><strong>${ev.summary}</strong><br>
                 ${start.toLocaleString()} - ${end.toLocaleString()}<br>
                 <span class="call-status ${status === 'CLASS IN SESSION' ? 'avoid' : status === 'UPCOMING' ? 'maybe' : 'safe'}">${status}</span></div>`;
      });
      container.innerHTML += html || "<p>No events found.</p>";
    }

    // Load schedule if params exist
    const params = new URLSearchParams(location.search);
    const name = params.get("name");
    const ics = params.get("ics");
    if (name && ics) {
      document.getElementById("link").innerHTML = `<strong>Viewing ${name}'s schedule</strong>`;
      renderSchedule(name, decodeURIComponent(ics));
    }
  </script>
</body>
</html>